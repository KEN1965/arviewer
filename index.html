<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AR Viewer Diagnostic Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js"></script>
    <style>
      html, body {
        margin: 0; padding: 0; height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #f2f5f8;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center;
      }
      header {
        position: absolute; top: 0; width: 100%;
        background-color: #0078d7; color: white;
        padding: 14px 0; font-size: 18px; font-weight: 600;
      }
      label {
        background-color: #0078d7; color: white;
        padding: 14px 28px; border-radius: 30px;
        cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: 0.3s;
      }
      label:hover { background-color: #005fa3; }
      input[type="file"] { display: none; }
      #log {
        background: #fff; border-radius: 8px; padding: 12px; width: 85%;
        margin-top: 20px; font-size: 14px; color: #333;
        text-align: left; white-space: pre-line;
      }
      footer {
        position: absolute; bottom: 10px; font-size: 12px; color: #555;
      }
    </style>
  </head>

  <body>
    <header>ğŸ” AR Viewer Diagnostic Test</header>

    <label for="fileInput">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (.glb / .usdz / .jpg / .png)</label>
    <input type="file" id="fileInput" accept=".glb,.usdz,.jpg,.jpeg,.png">

    <div id="log">ğŸ”¹ çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...</div>
    <footer>Â© 2025 Digital School LOCO</footer>

    <script>
      const log = document.getElementById("log");
      const fileInput = document.getElementById("fileInput");

      // ãƒ­ã‚°å‡ºåŠ›è£œåŠ©
      function write(msg) {
        console.log(msg);
        log.textContent += `\n${msg}`;
      }

      // åˆæœŸãƒã‚§ãƒƒã‚¯
      write("âœ… JavaScript å®Ÿè¡Œé–‹å§‹");
      if (window.isSecureContext) {
        write("ğŸ”’ HTTPSç’°å¢ƒã§ã™ï¼ˆOKï¼‰");
      } else {
        write("âš ï¸ HTTP ã¾ãŸã¯ file:// ã§é–‹ã„ã¦ã„ã¾ã™ã€‚HTTPSã§å†åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
      }

      if ('xr' in navigator) {
        write("ğŸ§­ WebXR API æ¤œå‡º: åˆ©ç”¨å¯èƒ½ã§ã™");
      } else {
        write("âš ï¸ WebXR API ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã€‚Safariè¨­å®šã§ WebXR ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚");
      }

      if (navigator.userAgent.includes("iPhone")) write("ğŸ“± iPhoneã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚");
      if (navigator.userAgent.includes("Android")) write("ğŸ¤– Androidã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚");

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        write(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name}`);

        const ext = file.name.split('.').pop().toLowerCase();
        const url = URL.createObjectURL(file);

        if (ext === "glb") {
          write("ğŸ§Š GLBãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ¤œå‡ºã€‚<model-viewer> ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚");
          testModelViewer(url);
        } else if (ext === "usdz") {
          write("ğŸ USDZãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ¤œå‡ºã€‚Quick Lookå¯¾å¿œã€‚");
          testModelViewer(url, true);
        } else if (["jpg","jpeg","png"].includes(ext)) {
          write("ğŸ–¼ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ¤œå‡ºã€‚Three.jsã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚");
          testThree(url);
        } else {
          write("â“ æœªå¯¾å¿œã®æ‹¡å¼µå­ã§ã™ã€‚");
        }
      });

      // --- model-viewerãƒ†ã‚¹ãƒˆ ---
      function testModelViewer(url, isUSDZ = false) {
        const mv = document.createElement("model-viewer");
        mv.setAttribute("ar", "");
        mv.setAttribute("camera-controls", "");
        mv.setAttribute("auto-rotate", "");
        mv.setAttribute("exposure", "1");
        mv.src = url;
        if (isUSDZ) mv.setAttribute("ios-src", url);
        mv.style.width = "80%";
        mv.style.height = "60vh";
        document.body.appendChild(mv);
        write("ğŸ¨ model-viewerã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ARãƒœã‚¿ãƒ³ãŒå‡ºã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }

      // --- Three.js ãƒ†ã‚¹ãƒˆ ---
      function testThree(url) {
        write("ğŸ¨ Three.jsã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
        const renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        document.body.appendChild(THREE.ARButton.createButton(renderer, { requiredFeatures: ["hit-test"] }));

        const texture = new THREE.TextureLoader().load(url);
        const geometry = new THREE.PlaneGeometry(0.5, 0.35);
        const material = new THREE.MeshBasicMaterial({map: texture, side: THREE.DoubleSide});
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.z = -1;
        scene.add(mesh);

        renderer.setAnimationLoop(() => renderer.render(scene, camera));
        write("ğŸ“¸ ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ARãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    </script>
  </body>
</html>
